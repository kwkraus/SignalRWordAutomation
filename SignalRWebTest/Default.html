<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="assets/bootstrap-3.3.7-dist/css/bootstrap.css" rel="stylesheet" />


    <title>SignalR Word Automation</title>
    <style type="text/css">
        .signalrcontainer {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Templates Found</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div id="templatelist" class="col-xs-4"></div>
                        <div id="jsonOutput" class="col-xs-4"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <div class="contaner" id="opendocs">
        <div>
            <input class="btn btn-primary btn-sm" type="button" id="openblankdoc" value="Open Blank Word Doc" />
            <input class="btn btn-primary btn-sm" type="button" id="closeword" value="Close All Docs" />
        </div>
        <br />
        <div>
            <a href="#" id="doc1">BCDoc1</a>&nbsp;<input class="btn btn-primary btn-sm" disabled type="button" id="closedoc1" value="Close" />
            &nbsp;<input class="btn btn-primary btn-sm" type="button" id="focusdoc1" value="FocusPinvoke" />&nbsp;<input class="btn btn-primary btn-sm" type="button" id="focusdoc2" value="FocusApp" /><span data-id="http://localhost:7694/BCDoc1.docm" id="docStatus"></span>
        </div>
        <div>
            <a href="#" id="docunc">UNCDoc</a>
        </div>
        <div><a href="ms-word:ofe|u|http://localhost:7694/BCDoc2.docx" id="doc2">BCDoc2</a>&nbsp;Open Doc using ms-word:ofe protocol</div>
        <br />
        <button id="getTemplates" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModal">
            Get Templates
        </button>

    </div>
    <div class="signalrcontainer">
        <a href="#" id="clearlog">Clear Log</a>
        <ul id="discussion"></ul>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-3.1.0.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:5050/signalr/hubs"></script>

    <script src="assets/bootstrap-3.3.7-dist/js/bootstrap.js"></script>


    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        function ServiceManager()
        {
            return {
                exec: function (options, isDeep)
                {
                    /*defaults*/
                    var defaults = {
                        type: 'GET',
                        url: '',
                        dataType: 'json',
                        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                        async: true,
                        params: {},
                        headers: {
                            'Accept': 'application/json; charset=utf-8',
                            'Content-Type': 'application/json; charset=utf-8'
                        }
                    },
                        timeout = 60000;
                    //default isDeep to true
                    isDeep = (isDeep === undefined) ? true : isDeep;
                    /*extend default with options;*/
                    options = $.extend(isDeep, {}, defaults, options);
                    $.ajax({
                        timeout: options.timeout || timeout,
                        type: options.type,
                        url: options.url,
                        dataType: options.dataType || 'jsonp',
                        data: options.params,
                        success: determineState,
                        error: options.error || null,
                        headers: options.headers,
                        contentType: options.contentType,
                        async: options.async,
                        enctype: options.enctype,
                        processData: options.processData,
                        cache: options.cache
                    });
                    function determineState(resp)
                    {
                        if (resp && resp.responseText)
                        {
                            resp = JSON.parse(resp.responseText);
                        }
                        if (resp && resp.businessResponse && resp.businessResponse.code === 'failure')
                        {
                            if (typeof options.error === "function")
                            {
                                options.error(resp);
                            }
                        } else if (typeof options.success === "function")
                        {
                            options.success(resp);
                        }
                    }
                }
            };
        }
        var serviceManager = ServiceManager();


        function getTemplates()
        {
            var deferred = $.Deferred();
            function success(resp)
            {
                deferred.resolve(resp);
            }
            function error()
            {
                deferred.reject();
            }
            serviceManager.exec({
                url: 'http://localhost:5050/api/template/gettemplatelist',
                success: success,
                error: error,
                headers: {
                    'Accept': 'application/json; charset=utf-8',
                    'Content-Type': 'application/json; charset=utf-8',
                    'Access-Control-Allow-Origin': true
                }
            }, false);
            return deferred.promise();
        }

        function getTemplateJson(name)
        {
            var deferred = $.Deferred();
            function success(resp)
            {
                deferred.resolve(resp);
            }
            function error()
            {
                deferred.reject();
            }
            serviceManager.exec({
                url: 'http://localhost:5050/api/template/gettemplate',
                params: { templateName: name },
                success: success,
                error: error,
                headers: {
                    'Accept': 'application/json; charset=utf-8',
                    'Content-Type': 'application/json; charset=utf-8',
                    'Access-Control-Allow-Origin': true
                }
            }, false);
            return deferred.promise();
        }


        $(function ()
        {
            $("#getTemplates").click(
                function ()
                {
                    getTemplates().done(function (resp)
                    {
                        var templates = resp;
                        var html = "";

                        $("#templatelist").empty();
                        $("#jsonOutput").empty();

                        templates.forEach(function (item, index)
                        {
                            html = '<button type="button" class="btn btn-primary btn-sm" id="' + index + '">' + item + '</button><br />';
                            $("#templatelist").append(html);
                            $("#" + index).click(
                                function ()
                                {
                                    getTemplateJson(item).done(function (resp)
                                    {
                                        $("#jsonOutput").text(JSON.stringify(resp));
                                    });
                                }
                            );
                        });
                    });
                }
            );

            //Set the hubs URL for the connection
            $.connection.hub.url = "http://localhost:5050/signalr";

            var baseUrl = window.location.origin;

            // Declare a proxy to reference the hub.
            var word = $.connection.wordHub;

            // Create a function that the hub can call to broadcast messages.
            word.client.addMessage = function (name, message)
            {
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + encodedName
                    + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
            };

            word.client.docClosed = function ()
            {
                $('#docStatus').text('Closed');
                $('#closedoc1').prop('disabled', true);
            };

            word.client.docOpened = function (docName)
            {
                $('#docStatus').attr('data-id').valueOf(docName).text('Opened');
                $('#closedoc1').prop('disabled', false);
            };

            word.client.wordDied = function ()
            {
                word.client.docClosed();
                word.client.addMessage('Browser', 'Word Died');
            };

            var incrementedId = 123;

            // Start the connection.
            $.connection.hub.logging = true;
            $.connection.hub.start().done(function ()
            {
                $('#openblankdoc').click(function ()
                {
                    incrementedId += 1;

                    word.server.openDoc('', incrementedId);
                });
                $('#closeword').click(function ()
                {
                    word.server.closeWord();
                });

                $('#doc1').click(function ()
                {
                    $('#docStatus').text('Opening...');
                    word.server.openDoc(baseUrl + '/BCDoc1.docm', '12345');
                });

                $('#docunc').click(function ()
                {
                    word.server.openDoc('\\\\UL96831\\docshare\\docunc.docx', '12345');
                });

                $('#closedoc1').click(function ()
                {
                    var str = $('#docStatus').text();
                    if (str == 'Opened')
                    {
                        $('#docStatus').text('Closing...')
                        word.server.closeDoc(baseUrl + '/BCDoc1.docm');
                    }
                });

                $('#focusdoc1').click(function ()
                {
                    var str = $('#docStatus').text();

                    $('#docStatus').text('Focusing...');
                    word.server.focusDocPInoke(baseUrl + '/BCDoc1.docm');

                });

                $('#focusdoc2').click(function ()
                {
                    var str = $('#docStatus').text();

                    $('#docStatus').text('Focusing...');
                    word.server.focusDocApp(baseUrl + '/BCDoc1.docm');

                });

                $('#clearlog').click(function ()
                {
                    $('#discussion').text('');
                });
            });
        });
    </script>
</body>
</html>
